name: ci

on:
  push:
  pull_request:

jobs:
  mtci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false
      - name: Install dependencies
        run: uv sync --locked --dev
      - name: Start MTCI server
        env:
          MTCI_LIGHT_MODEL: "1"
        run: |
          uv run mtci serve --host 127.0.0.1 --port 8000 &
          for i in {1..20}; do
            if curl -s http://127.0.0.1:8000/health | grep -q ok; then
              echo "server ready"
              exit 0
            fi
            sleep 1
          done
          echo "server not ready" && exit 1
      - name: Run MTCI
        run: uv run mtci run --config mtci.endpoint.yml --profile pr-fast --out mtci_artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mtci_artifacts
          path: mtci_artifacts/
